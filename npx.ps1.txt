##
## Saturday, 25 October 2025, 09:27
## Included here just for posterity. This file is shipped by nvm, and normally
## lives at C:\nvm4w\nodejs\npx.ps1 . The changes here modify the encoding so
## that apheleia and prettier work properly on Windows. After an update to nvm,
## npx.ps1 will be different and I will need to re-apply the changes.
##


#!/usr/bin/env pwsh

Set-StrictMode -Version 'Latest'

$NODE_EXE="$PSScriptRoot/node.exe"
if (-not (Test-Path $NODE_EXE)) {
  $NODE_EXE="$PSScriptRoot/node"
}
if (-not (Test-Path $NODE_EXE)) {
  $NODE_EXE="node"
}

$NPM_PREFIX_JS="$PSScriptRoot/node_modules/npm/bin/npm-prefix.js"
$NPX_CLI_JS="$PSScriptRoot/node_modules/npm/bin/npx-cli.js"
$NPM_PREFIX=(& $NODE_EXE $NPM_PREFIX_JS)

if ($LASTEXITCODE -ne 0) {
  Write-Host "Could not determine Node.js install directory"
  exit 1
}

$NPM_PREFIX_NPX_CLI_JS="$NPM_PREFIX/node_modules/npm/bin/npx-cli.js"
if (Test-Path $NPM_PREFIX_NPX_CLI_JS) {
  $NPX_CLI_JS=$NPM_PREFIX_NPX_CLI_JS
}

# Dino - 20260131-1245, for apheleia-mode
# Apply desired UTF8 settings
$OriginalConsoleOutputEncoding = [Console]::OutputEncoding
# Create one instance of UTF8 that encodes without a BOM
$Utf8NoBom = New-Object System.Text.UTF8Encoding($false)
# 1. Use it for pipes between programs
$OutputEncoding = $Utf8NoBom
# 2. Use it for the final output to the console/editor
[Console]::OutputEncoding = $Utf8NoBom


if ($MyInvocation.ExpectingInput) { # takes pipeline input
  $input | & $NODE_EXE $NPX_CLI_JS $args
} elseif (-not $MyInvocation.Line) { # used "-File" argument
  & $NODE_EXE $NPX_CLI_JS $args
} else { # used "-Command" argument
  if (($MyInvocation | Get-Member -Name 'Statement') -and $MyInvocation.Statement) {
    $NPX_ORIGINAL_COMMAND = $MyInvocation.Statement
  } else {
    $NPX_ORIGINAL_COMMAND = (
      [Management.Automation.InvocationInfo].GetProperty('ScriptPosition', [Reflection.BindingFlags] 'Instance, NonPublic')
    ).GetValue($MyInvocation).Text
  }

  $NODE_EXE = $NODE_EXE.Replace("``", "````")
  $NPX_CLI_JS = $NPX_CLI_JS.Replace("``", "````")

  $NPX_COMMAND_ARRAY = [Management.Automation.Language.Parser]::ParseInput($NPX_ORIGINAL_COMMAND, [ref] $null, [ref] $null).
    EndBlock.Statements.PipelineElements.CommandElements.Extent.Text
  $NPX_ARGS = ($NPX_COMMAND_ARRAY | Select-Object -Skip 1) -join ' '

  Invoke-Expression "& `"$NODE_EXE`" `"$NPX_CLI_JS`" $NPX_ARGS"
}

# Dino - 20260131-1245, for apheleia-mode
$OutputEncoding = $OriginalConsoleOutputEncoding
[Console]::OutputEncoding = $OriginalConsoleOutputEncoding

exit $LASTEXITCODE
